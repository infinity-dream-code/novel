<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Mystery Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title {
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .timer {
            font-size: 1.5em;
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .story-section, .clues-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            color: #ffd700;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 5px;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .clue-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #4ecdc4;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clue-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .clue-collected {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .suspects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .suspect-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .suspect-card:hover {
            transform: translateY(-5px);
            border-color: #ffd700;
        }

        .suspect-selected {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }

        .suspect-name {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .answer-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .solve-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffd700);
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .solve-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .solve-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #ffd700);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .hint-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .hint-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .suspects-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .title {
                font-size: 2em;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header fade-in">
            <h1 class="title">üîç MYSTERY DETECTIVE GAME</h1>
            <div class="timer" id="timer">‚è∞ Waktu Tersisa: 10:00</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <p>Selesaikan misteri pembunuhan di mansion sebelum waktu habis!</p>
        </div>

        <div class="game-area">
            <div class="story-section fade-in">
                <h2 class="section-title">üìñ Cerita</h2>
                <div class="story-text" id="story">
                    <p><strong>Pembunuhan di Blackwood Mansion</strong></p>
                    <p>Tuan Blackwood, pemilik mansion mewah, ditemukan tewas di perpustakaannya malam ini. Anda adalah detektif yang dipanggil untuk memecahkan kasus ini.</p>
                    <p>Ada 4 tersangka dan berbagai petunjuk tersebar di mansion. Waktu Anda terbatas - polisi akan datang dalam 10 menit!</p>
                    <p><em>Klik pada petunjuk untuk mengumpulkannya dan temukan siapa pembunuhnya...</em></p>
                </div>
                <button class="hint-btn" onclick="showHint()">üí° Petunjuk</button>
            </div>

            <div class="clues-section fade-in">
                <h2 class="section-title">üîç Petunjuk</h2>
                <div id="clues-container">
                    <div class="clue-item" onclick="collectClue(0)" id="clue0">
                        <strong>üî™ Pisau Berdarah</strong><br>
                        Ditemukan di dapur dengan sidik jari yang terhapus sebagian
                    </div>
                    <div class="clue-item" onclick="collectClue(1)" id="clue1">
                        <strong>üìÑ Surat Ancaman</strong><br>
                        "Kamu akan membayar atas yang telah kamu lakukan!" - Tanpa tanda tangan
                    </div>
                    <div class="clue-item" onclick="collectClue(2)" id="clue2">
                        <strong>üí∞ Cek Kosong</strong><br>
                        Cek senilai $50,000 yang belum ditandatangani di meja korban
                    </div>
                    <div class="clue-item" onclick="collectClue(3)" id="clue3">
                        <strong>üö¨ Puntung Rokok</strong><br>
                        Merek mahal ditemukan di teras, masih hangat
                    </div>
                    <div class="clue-item" onclick="collectClue(4)" id="clue4">
                        <strong>üë† Sepatu Hak Tinggi</strong><br>
                        Sepatu wanita dengan bercak darah di bawah tangga
                    </div>
                </div>
            </div>
        </div>

        <div class="suspects-grid fade-in">
            <div class="suspect-card" onclick="selectSuspect(0)" id="suspect0">
                <div class="suspect-name">üë®‚Äçüíº James Butler</div>
                <p><strong>Kepala Pelayan</strong></p>
                <p>Bekerja 20 tahun, akses ke seluruh rumah. Terlihat gugup malam ini.</p>
            </div>
            <div class="suspect-card" onclick="selectSuspect(1)" id="suspect1">
                <div class="suspect-name">üíÉ Victoria Blackwood</div>
                <p><strong>Istri Muda</strong></p>
                <p>Menikah 2 tahun lalu. Sering bertengkar dengan suami tentang uang.</p>
            </div>
            <div class="suspect-card" onclick="selectSuspect(2)" id="suspect2">
                <div class="suspect-name">üéì Dr. Harrison</div>
                <p><strong>Partner Bisnis</strong></p>
                <p>Investor besar yang baru saja kehilangan banyak uang dalam bisnis bersama.</p>
            </div>
            <div class="suspect-card" onclick="selectSuspect(3)" id="suspect3">
                <div class="suspect-name">üë®‚Äçüç≥ Marco Chef</div>
                <p><strong>Chef Pribadi</strong></p>
                <p>Baru bekerja 3 bulan. Memiliki masa lalu kriminal yang disembunyikan.</p>
            </div>
        </div>

        <div class="answer-section fade-in">
            <h2 class="section-title">‚öñÔ∏è Solusi Anda</h2>
            <p id="selection-text">Pilih tersangka dan kumpulkan petunjuk untuk menyelesaikan kasus!</p>
            <button class="solve-btn" onclick="solveCase()" id="solve-button" disabled>
                üéØ SELESAIKAN KASUS
            </button>
        </div>
    </div>

    <script>
        let gameData = {
            timeLeft: 600, // 10 minutes in seconds
            cluesCollected: [],
            selectedSuspect: -1,
            gameEnded: false,
            correctSuspect: 1, // Victoria Blackwood (index 1)
            requiredClues: [1, 2, 4] // Surat ancaman, Cek kosong, Sepatu hak tinggi
        };

        const suspects = [
            "James Butler", "Victoria Blackwood", "Dr. Harrison", "Marco Chef"
        ];

        let timerInterval;

        // Start the game timer
        function startTimer() {
            timerInterval = setInterval(() => {
                if (gameData.gameEnded) {
                    clearInterval(timerInterval);
                    return;
                }

                gameData.timeLeft--;
                updateTimerDisplay();
                updateProgress();

                if (gameData.timeLeft <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameData.timeLeft / 60);
            const seconds = gameData.timeLeft % 60;
            const display = `‚è∞ Waktu Tersisa: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer').textContent = display;
            
            // Change color when time is running low
            const timerElement = document.getElementById('timer');
            if (gameData.timeLeft < 120) { // Less than 2 minutes
                timerElement.style.color = '#ff4757';
                timerElement.classList.add('pulse');
            } else if (gameData.timeLeft < 300) { // Less than 5 minutes
                timerElement.style.color = '#ffa726';
            }
        }

        function updateProgress() {
            const totalRequiredActions = 4; // 3 correct clues + 1 correct suspect
            const completedActions = gameData.cluesCollected.filter(clue => 
                gameData.requiredClues.includes(clue)).length + 
                (gameData.selectedSuspect === gameData.correctSuspect ? 1 : 0);
            
            const progress = (completedActions / totalRequiredActions) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        function collectClue(clueIndex) {
            if (gameData.cluesCollected.includes(clueIndex) || gameData.gameEnded) {
                return;
            }

            gameData.cluesCollected.push(clueIndex);
            const clueElement = document.getElementById(`clue${clueIndex}`);
            clueElement.classList.add('clue-collected');
            
            // Add collection animation
            clueElement.style.transform = 'scale(1.1)';
            setTimeout(() => {
                clueElement.style.transform = 'scale(1)';
            }, 200);

            updateProgress();
            checkCanSolve();
            
            // Show clue-specific feedback
            showClueMessage(clueIndex);
        }

        function showClueMessage(clueIndex) {
            const messages = [
                "Pisau pembunuh... tapi siapa yang menggunakannya?",
                "Surat ancaman ini pasti dari seseorang yang dendam!",
                "Cek besar... mungkin motif pembunuhan?",
                "Rokok mahal... tersangka mana yang merokok?",
                "Sepatu wanita... ini milik siapa?"
            ];
            
            swal({
                title: "Petunjuk Terkumpul!",
                text: messages[clueIndex],
                icon: "info",
                button: "Lanjutkan Investigasi",
                timer: 2000
            });
        }

        function selectSuspect(suspectIndex) {
            if (gameData.gameEnded) return;

            // Remove previous selection
            document.querySelectorAll('.suspect-card').forEach(card => {
                card.classList.remove('suspect-selected');
            });

            // Add selection to clicked suspect
            gameData.selectedSuspect = suspectIndex;
            document.getElementById(`suspect${suspectIndex}`).classList.add('suspect-selected');
            
            updateSelectionText();
            updateProgress();
            checkCanSolve();
        }

        function updateSelectionText() {
            const text = gameData.selectedSuspect !== -1 
                ? `Tersangka terpilih: ${suspects[gameData.selectedSuspect]} | Petunjuk terkumpul: ${gameData.cluesCollected.length}/5`
                : `Pilih tersangka dan kumpulkan petunjuk untuk menyelesaikan kasus!`;
            
            document.getElementById('selection-text').textContent = text;
        }

        function checkCanSolve() {
            const hasCorrectClues = gameData.requiredClues.every(clue => 
                gameData.cluesCollected.includes(clue));
            const hasSuspect = gameData.selectedSuspect !== -1;
            
            document.getElementById('solve-button').disabled = !(hasCorrectClues && hasSuspect);
        }

        function solveCase() {
            if (gameData.gameEnded) return;
            
            gameData.gameEnded = true;
            clearInterval(timerInterval);

            const hasCorrectClues = gameData.requiredClues.every(clue => 
                gameData.cluesCollected.includes(clue));
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance:none; border:1px solid rgba(255,255,255,.1); background: #11151d;
      color:#eaf0ff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
      transition:transform .1s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{ transform: translateY(-1px); border-color: var(--accent); }
    button.primary{ background: linear-gradient(180deg, #29314a, #22283a); border-color: rgba(124,156,255,.6); }
    button[disabled]{ opacity:.5; cursor:not-allowed }

    .notebook{ width:100%; min-height:120px; resize:vertical; padding:12px; background:#0f131b; color:#dbe6ff; border:1px solid rgba(255,255,255,.1); border-radius:10px}
    .log{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0a0d12; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; max-height:220px; overflow:auto; color:#c8d2e3 }
    .log p{ margin:0 0 6px }
    .muted{ color:var(--muted) }

    dialog{
      border:none; border-radius:16px; max-width:520px; width:calc(100% - 24px);
      background:linear-gradient(180deg,#1b202b,#121723); color:var(--text);
      border:1px solid rgba(255,255,255,.08); box-shadow: var(--shadow);
      padding:0;
    }
    dialog::backdrop{ background: rgba(0,0,0,.45); backdrop-filter: blur(2px) }
    .modal-head{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); font-weight:700 }
    .modal-body{ padding:16px; display:grid; gap:12px }
    .radio{ display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:10px }
    .success{ border-left:4px solid var(--accent-2); padding:10px; background:rgba(98,212,160,.06)}
    .danger{ border-left:4px solid var(--danger); padding:10px; background:rgba(255,107,107,.06)}
    .chips{ display:flex; gap:6px; flex-wrap:wrap }
    .tiny{ font-size:12px }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="badge">üïµÔ∏è‚Äç‚ôÄÔ∏è Kasus Interaktif</div>
        <h1 style="font-size:20px; margin:8px 0">Malam di Vila Cempaka</h1>
        <span class="badge" id="progressBadge" aria-live="polite">Bukti kunci: 0/4</span>
        <span class="badge">Langkah: <span id="steps">0</span></span>
        <div style="flex:1"></div>
        <button id="resetBtn" title="Mulai ulang kasus">üîÑ Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" id="app">
    <section class="panel">
      <h2>üó∫Ô∏è Lokasi</h2>
      <div class="body">
        <div class="locations" id="locations"></div>
        <hr style="border-color: rgba(255,255,255,.08); margin:14px 0">
        <div id="clueArea">
          <div class="muted tiny">Pilih lokasi untuk melihat petunjuk‚Ä¶</div>
        </div>
      </div>
    </section>

    <aside class="panel">
      <h2>üßë‚Äçü§ù‚Äçüßë Suspek & Deduksi</h2>
      <div class="body" id="suspectArea">
        <div class="suspects" id="suspects"></div>
        <div style="height:10px"></div>
        <div class="toolbar">
          <button class="primary" id="accuseBtn" disabled>‚öñÔ∏è Ajukan Tuduhan</button>
          <button id="interrogateBtn">üí¨ Interogasi Terbatas</button>
        </div>
        <p class="tiny muted">Catatan: tombol tuduhan aktif setelah 4 bukti kunci ditemukan.</p>
      </div>
    </aside>

    <section class="panel" style="grid-column:1 / -1">
      <h2>üìí Notebook & Log</h2>
      <div class="body">
        <div class="toolbar" style="margin-bottom:8px">
          <button id="copyNotes">üìã Salin Catatan</button>
        </div>
        <textarea class="notebook" id="notes" placeholder="Tulis hipotesis, timeline, atau hubungan antar tokoh di sini‚Ä¶"></textarea>
        <div style="height:12px"></div>
        <div class="log" id="log" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <!-- Modal Tuduhan -->
  <dialog id="accuseModal" aria-labelledby="accuseTitle">
    <div class="modal-head" id="accuseTitle">Ajukan Tuduhan</div>
    <form method="dialog" class="modal-body" id="accuseForm">
      <div class="tiny muted">Pilih pelaku menurut deduksi kamu. (Tips: Periksa status ‚ÄúMungkin‚Äù di kartu suspek.)</div>
      <div id="accuseList"></div>
      <div>
        <div class="tiny muted" style="margin-bottom:6px">Sertakan bukti pendukung (otomatis terisi dari bukti kunci):</div>
        <div class="chips" id="proofChips"></div>
      </div>
      <div class="toolbar">
        <button value="cancel">Tutup</button>
        <button class="primary" value="submit">Kunci Tuduhan</button>
      </div>
    </form>
  </dialog>

  <!-- Modal Interogasi -->
  <dialog id="askModal" aria-labelledby="askTitle">
    <div class="modal-head" id="askTitle">Interogasi Singkat</div>
    <form method="dialog" class="modal-body" id="askForm">
      <div class="tiny muted">Kamu punya <b id="qLeft">8</b> pertanyaan lagi.</div>
      <div class="chips" id="askTargets"></div>
      <div id="askOutput" class="tiny muted"></div>
      <div class="toolbar">
        <button value="cancel">Tutup</button>
      </div>
    </form>
  </dialog>

  <script>
  // ---------- DATA KASUS ----------
  const SUSPECTS = [
    { id:'rina', emoji:'üï∂Ô∏è', name:'Rina Putri', role:'Fotografer lepas',
      left:true, shoe:38, perfume:'Nocturne',
      bio:'Kenalan lama korban. Sering meliput acara vila.',
      alibi:'Mengaku di teras melakukan panggilan telepon.',
      qa:{
        default:'‚ÄúAku hanya mampir sebentar untuk ambil lensa.‚Äù',
        relation:'‚ÄúKami sempat berdebat soal artikel, tapi itu biasa.‚Äù',
        perfume:'‚Äú‚Ä¶aku suka parfum malam. Kenapa?‚Äù',
        alibi:'‚Äú‚Ä¶sinyalku putus sebentar. Aku tetap di teras.‚Äù'
      }
    },
    { id:'bima', emoji:'üç≥', name:'Bima Adi', role:'Koki pribadi',
      left:false, shoe:42, perfume:'Citrus',
      bio:'Bekerja di vila tiga tahun terakhir.',
      alibi:'Menyiapkan makan malam sambil live IG.',
      qa:{
        default:'‚ÄúAku di dapur, ada rekaman live.‚Äù',
        relation:'‚ÄúKorban cerewet, tapi baik.‚Äù'
      }
    },
    { id:'sari', emoji:'üë©‚Äçüíº', name:'Sari Wulandari', role:'Sepupu korban',
      left:false, shoe:39, perfume:'Floral',
      bio:'Datang untuk diskusi warisan.',
      alibi:'Rapat Zoom dengan notaris.',
      qa:{
        default:'‚ÄúAku di ruang tamu, panggilan video panjang.‚Äù'
      }
    },
    { id:'dodi', emoji:'üõ°Ô∏è', name:'Dodi Saputra', role:'Satpam',
      left:false, shoe:41, perfume:'Woody',
      bio:'Ronda keliling tiap 15 menit.',
      alibi:'Catatan patroli beruntun tanpa jeda.',
      qa:{
        default:'‚ÄúAku cuma keliling seperti biasa.‚Äù'
      }
    }
  ];

  const LOCATIONS = [
    { id:'study', emoji:'üìö', name:'Ruang Kerja',
      clues:[
        { id:'clue_strikeLeft', key:true, title:'Arah Pukulan',
          text:'Polanya menunjukkan hantaman dari sisi kiri (pelaku kidal).',
          effect: (s)=>{ s.evidence.strike='left'; }
        },
        { id:'clue_cologne', key:true, title:'Jejak Aroma',
          text:'Terdapat aroma parfum malam ‚ÄúNocturne‚Äù.',
          effect: (s)=>{ s.evidence.scent='Nocturne'; }
        },
        { id:'clue_statue', key:false, title:'Patung Retak',
          text:'Patung batu berat dengan noda darah ‚Äî senjata kemungkinan.',
          effect: (s)=>{ s.evidence.weapon='Patung'; }
        }
      ]
    },
    { id:'kitchen', emoji:'üçΩÔ∏è', name:'Dapur',
      clues:[
        { id:'clue_bimaStream', key:true, title:'Live IG Bima',
          text:'Tripod menyala merekam Bima 10.05‚Äì10.25 (alibi kuat).',
          effect:(s)=>{ s.evidence.alibi_bima=true; }
        }
      ]
    },
    { id:'garden', emoji:'üåø', name:'Taman',
      clues:[
        { id:'clue_foot', key:false, title:'Jejak Kecil',
          text:'Jejak sepatu basah ukuran 38‚Äì39 menuju ruang kerja.',
          effect:(s)=>{ s.evidence.foot=[38,39]; }
        }
      ]
    },
    { id:'veranda', emoji:'üì±', name:'Teras',
      clues:[
        { id:'clue_rinaPhone', key:false, title:'Log Telepon Rina',
          text:'Koneksi terputus 10.12‚Äì10.20, celah pada alibi.',
          effect:(s)=>{ s.evidence.rinaPhoneGap=true; }
        }
      ]
    },
    { id:'security', emoji:'üìã', name:'Pos Satpam',
      clues:[
        { id:'clue_guardLog', key:true, title:'Log Patroli',
          text:'Catatan Dodi konsisten tiap 15 menit (alibi kuat).',
          effect:(s)=>{ s.evidence.alibi_dodi=true; }
        }
      ]
    },
    { id:'living', emoji:'üõãÔ∏è', name:'Ruang Tamu',
      clues:[
        { id:'clue_argument', key:false, title:'Pesan Dihapus',
          text:'Restore ponsel: perdebatan tajam korban‚ÄìRina soal artikel.',
          effect:(s)=>{ s.evidence.motive_rina=true; }
        }
      ]
    }
  ];

  // Bukti kunci minimum agar tombol tuduhan aktif
  const REQUIRED_KEY_IDS = ['clue_strikeLeft','clue_cologne','clue_bimaStream','clue_guardLog'];
  const STORAGE_KEY = 'detective-state-v1';

  // ---------- STATE ----------
  const defaultState = () => ({
    found: [],          // id petunjuk
    evidence: {},       // fakta terstruktur
    steps: 0,           // jumlah aksi
    lastLocation: null,
    notes: '',
    questionsLeft: 8
  });
  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      // sanitasi minimal
      if(!s || typeof s !== 'object') return defaultState();
      return Object.assign(defaultState(), s);
    }catch(e){ return defaultState(); }
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function step(n=1){ state.steps += n; document.getElementById('steps').textContent = state.steps; saveState(); }

  // ---------- UI RENDER ----------
  const el = (sel)=>document.querySelector(sel);
  const $locations = el('#locations');
  const $clueArea = el('#clueArea');
  const $suspects = el('#suspects');
  const $log = el('#log');
  const $progressBadge = el('#progressBadge');
  const $notes = el('#notes');

  function renderLocations(){
    $locations.innerHTML = LOCATIONS.map(loc => `
      <button class="card" data-loc="${loc.id}" aria-label="Buka ${loc.name}">
        <div class="emoji">${loc.emoji}</div>
        <div>
          <div class="name">${loc.name}</div>
          <small>${loc.clues.length} petunjuk</small>
        </div>
      </button>
    `).join('');
  }

  function renderClues(locId){
    const loc = LOCATIONS.find(l=>l.id===locId);
    if(!loc) return;
    state.lastLocation = locId; saveState();
    const items = loc.clues.map(c=>{
      const taken = state.found.includes(c.id);
      return `
      <div class="clue" data-clue="${c.id}">
        <div class="txt">
          <strong>${c.title}</strong><br>
          <span class="muted">${c.text}</span>
        </div>
        <div>
          <button ${taken?'disabled':''} data-act="take">${taken?'Tersimpan':'Ambil'}</button>
        </div>
      </div>`;
    }).join('');
    $clueArea.innerHTML = `<div class="clues">${items}</div>`;
  }

  function computePossible(){
    // Filter suspek berdasarkan evidence yang ada
    let possible = [...SUSPECTS];
    const e = state.evidence;
    if(e.strike==='left'){
      possible = possible.filter(p=>p.left);
    }
    if(e.scent==='Nocturne'){
      possible = possible.filter(p=>p.perfume==='Nocturne');
    }
    if(Array.isArray(e.foot)){
      possible = possible.filter(p=> e.foot.includes(p.shoe));
    }
    if(e.alibi_bima){ possible = possible.filter(p=>p.id!=='bima'); }
    if(e.alibi_dodi){ possible = possible.filter(p=>p.id!=='dodi'); }
    // (Catatan: gap telepon Rina & motif tidak mengeliminasi orang lain‚Äîhanya penguat)
    return possible;
  }

  function renderSuspects(){
    const possible = computePossible().map(p=>p.id);
    $suspects.innerHTML = SUSPECTS.map(p=>{
      const isPossible = possible.includes(p.id);
      const tags = [
        p.left ? '<span class="tag">kidal</span>' : '<span class="tag">kanan</span>',
        `<span class="tag">uk. sepatu ${p.shoe}</span>`,
        `<span class="tag">parfum ${p.perfume}</span>`,
        isPossible ? '<span class="tag ok">MUNGKIN</span>' : '<span class="tag no">TERELIMINASI</span>'
      ].join(' ');
      return `
        <div class="sus">
          <div class="pfp" aria-hidden="true">${p.emoji}</div>
          <div>
            <div class="nm">${p.name}</div>
            <div class="meta">${p.role}</div>
            <div class="tiny muted" style="margin-top:6px">${p.bio}</div>
            <div style="margin-top:8px" class="chips">${tags}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderProgress(){
    const keysFound = state.found.filter(id=>REQUIRED_KEY_IDS.includes(id)).length;
    $progressBadge.textContent = `Bukti kunci: ${keysFound}/${REQUIRED_KEY_IDS.length}`;
    el('#accuseBtn').disabled = keysFound < REQUIRED_KEY_IDS.length;
  }

  function log(msg){
    const p = document.createElement('p');
    p.innerHTML = msg;
    $log.prepend(p);
  }

  // ---------- INTERAKSI ----------
  $locations.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-loc]');
    if(!btn) return;
    renderClues(btn.dataset.loc);
    step();
  });

  $clueArea.addEventListener('click', (e)=>{
    const clueEl = e.target.closest('[data-clue]');
    if(!clueEl) return;
    const id = clueEl.dataset.clue;
    const act = e.target.getAttribute('data-act');
    if(act!=='take') return;
    if(state.found.includes(id)) return;

    // Temukan petunjuk & terapkan efeknya
    let foundObj = null;
    for(const loc of LOCATIONS){
      const c = loc.clues.find(x=>x.id===id);
      if(c){ foundObj = c; break; }
    }
    if(!foundObj) return;

    try{ foundObj.effect(state); }catch(_){}
    state.found.push(id);
    saveState();
    renderClues(state.lastLocation);
    renderSuspects();
    renderProgress();

    const keyBadge = foundObj.key ? ' <span class="tag ok">BUKTI KUNCI</span>' : '';
    log(`üß© <b>${foundObj.title}</b> tersimpan.${keyBadge}`);
    step();
  });

  // Tuduhan
  el('#accuseBtn').addEventListener('click', ()=>{
    const dlg = el('#accuseModal');
    const possible = computePossible();
    const list = possible.length ? possible : SUSPECTS; // tetap tampilkan semua jika filter terlalu ketat
    el('#accuseList').innerHTML = list.map((p,i)=>`
      <label class="radio"><input type="radio" name="sus" value="${p.id}" ${i===0?'checked':''}>
        <div><b>${p.name}</b><div class="tiny muted">${p.role}</div></div>
      </label>
    `).join('');
    // Bukti kunci yang dipakai
    const proofs = state.found.filter(id=>REQUIRED_KEY_IDS.includes(id));
    el('#proofChips').innerHTML = proofs.map(id=>{
      const loc = LOCATIONS.find(l=>l.clues.find(c=>c.id===id));
      const c = loc.clues.find(x=>x.id===id);
      return `<span class="tag">${c.title}</span>`;
    }).join('') || '<span class="muted tiny">Belum ada.</span>';

    dlg.showModal();
  });

  el('#accuseForm').addEventListener('close', ()=>{
    if(el('#accuseForm').returnValue!=='submit') return;
    const chosen = new FormData(el('#accuseForm')).get('sus');
    // Jawaban benar: Rina
    const correct = 'rina';
    const ok = chosen===correct;

    const result = document.createElement('div');
    result.style.marginTop = '10px';
    if(ok){
      const steps = state.steps;
      const keys = state.found.filter(id=>REQUIRED_KEY_IDS.includes(id)).length;
      const stars = steps <= 18 ? '‚òÖ‚òÖ‚òÖ' : steps <= 26 ? '‚òÖ‚òÖ' : '‚òÖ';
      result.innerHTML = `
        <div class="success">
          <b>Tepat!</b> Pelaku adalah <b>Rina Putri</b>. Motif: konflik artikel & tekanan kerja.
          Senjata: <i>patung batu</i> di ruang kerja.
          <div class="tiny">Alasan: kidal (arah pukulan), jejak parfum ‚ÄúNocturne‚Äù, alibi Bima & Dodi terverifikasi, celah telepon Rina 10.12‚Äì10.20, dan pesan perdebatan.</div>
          <div style="margin-top:6px" class="tiny">Skor: ${stars} ‚Äî langkah ${steps}, bukti kunci ${keys}/${REQUIRED_KEY_IDS.length}.</div>
        </div>`;
      log(result.innerHTML);
    } else {
      result.innerHTML = `<div class="danger"><b>Belum tepat.</b> Bukti yang ada belum cukup mendukung tuduhan tersebut. Kumpulkan lebih banyak bukti kunci lalu coba lagi.</div>`;
      log(result.innerHTML);
    }
    step();
  });

  // Interogasi sederhana
  el('#interrogateBtn').addEventListener('click', ()=>{
    const dlg = el('#askModal');
    el('#qLeft').textContent = state.questionsLeft;
    el('#askOutput').innerHTML = `<div class="tiny muted">Pilih suspek untuk mendengar jawabannya‚Ä¶</div>`;
    el('#askTargets').innerHTML = SUSPECTS.map(p=>`<button data-ask="${p.id}">${p.emoji} ${p.name.split(' ')[0]}</button>`).join('');
    dlg.showModal();
  });
  el('#askForm').addEventListener('click',(e)=>{
    const b = e.target.closest('[data-ask]'); if(!b) return;
    if(state.questionsLeft<=0){ el('#askOutput').innerHTML='<span class="tiny muted">Pertanyaanmu habis.</span>'; return; }
    state.questionsLeft -= 1; saveState();
    el('#qLeft').textContent = state.questionsLeft;
    const id = b.dataset.ask;
    const p = SUSPECTS.find(x=>x.id===id);
    // Jawaban bisa berubah jika bukti tertentu ditemukan
    let answer = p.qa?.default || '‚Ä¶';
    if(id==='rina'){
      if(state.evidence.motive_rina) answer = p.qa.relation;
      if(state.evidence.scent==='Nocturne') answer = p.qa.perfume;
      if(state.evidence.rinaPhoneGap) answer = p.qa.alibi;
    }
    if(id==='bima' && state.evidence.alibi_bima){ answer = p.qa.default + ' (Cek: rekaman tersimpan.)'; }
    if(id==='dodi' && state.evidence.alibi_dodi){ answer = p.qa.default + ' (Log patroli rapi.)'; }

    el('#askOutput').innerHTML = `<b>${p.name}:</b> ‚Äú${answer}‚Äù`;
  });

  // Notebook, salin & reset
  $notes.value = state.notes || '';
  $notes.addEventListener('input', ()=>{ state.notes = $notes.value; saveState(); });
  el('#copyNotes').addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText($notes.value);
      log('üìí Catatan disalin ke clipboard.');
    }catch(_){ log('‚ö†Ô∏è Gagal menyalin catatan.'); }
    step();
  });
  el('#resetBtn').addEventListener('click', ()=>{
    if(confirm('Mulai ulang kasus dan hapus progress?')){
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      boot();
      log('üîÑ Kasus di-reset.');
    }
  });

  // ---------- BOOT ----------
  function boot(){
    renderLocations();
    renderSuspects();
    renderProgress();
    document.getElementById('steps').textContent = state.steps;
    if(state.lastLocation) renderClues(state.lastLocation);
    // tampilkan bukti yang sudah dikumpulkan di log (sekali saat boot)
    if(state.found.length){
      log(`üì¶ Memuat progress: ${state.found.length} bukti tersimpan.`);
    }else{
      log('üïØÔ∏è Korban ditemukan di ruang kerja. Kumpulkan petunjuk, bandingkan dengan profil suspek, lalu ajukan tuduhan.');
    }
  }
  boot();
  </script>
</body>
</html>

